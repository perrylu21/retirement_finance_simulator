<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€€ä¼‘è²¡å‹™æ¨¡æ“¬å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        input:disabled {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .table-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            text-align: right;
            outline: none;
        }
        .table-input:focus {
            border-color: #3b82f6;
            ring: 2px solid #bfdbfe;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-[1600px] mx-auto">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-slate-800">é€€ä¼‘è²¡å‹™ç®¡ç†å·¥å…·</h1>
            <p class="text-slate-500 mt-2">æ•´åˆæŠ•è³‡è¤‡åˆ©è¨ˆç®—èˆ‡é€€ä¼‘è³‡ç”¢å£½å‘½è¦åŠƒ</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- 1. æŠ•è³‡å ±é…¬ç‡è¨ˆç®—æ©Ÿ (æœ€å·¦æ–¹) -->
            <div class="card p-5 space-y-4 border-t-4 border-indigo-500">
                <h2 class="text-xl font-bold text-indigo-700 flex items-center">
                    <span class="mr-2">ğŸ“ˆ</span> æŠ•è³‡å›å ±è¨ˆç®—æ©Ÿ
                </h2>
                <p class="text-xs text-slate-400">ç´¯ç©æœŸï¼šè¨ˆç®—é€€ä¼‘å‰çš„è³‡ç”¢å¢é•·</p>
                
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-600 font-bold text-indigo-600">ç•¶å‰å¹´é½¡</label>
                    <input type="number" id="currentAge" value="52" class="w-full p-2 border border-indigo-200 rounded-md outline-none focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="space-y-2 text-indigo-600">
                    <label class="block text-sm font-medium font-bold">åˆå§‹è³‡é‡‘ (è¬)</label>
                    <input type="number" id="calcInitial" value="3500" class="w-full p-2 border border-indigo-200 rounded-md outline-none focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-600">é è¨ˆå†æŠ•è³‡æœŸé–“ (å¹´)</label>
                    <input type="number" id="calcYears" value="10" class="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-600">å®šæœŸæŠ•å…¥</label>
                        <select id="calcFreq" class="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-indigo-400">
                            <option value="1">æ¯å¹´</option>
                            <option value="2">æ¯åŠå¹´</option>
                            <option value="4">æ¯å­£</option>
                            <option value="12" selected>æ¯æœˆ</option>
                        </select>
                    </div>
                    <div class="space-y-2 text-indigo-600">
                        <label class="block text-sm font-medium font-bold">é‡‘é¡ (è¬)</label>
                        <input type="number" id="calcAddAmount" value="15" class="w-full p-2 border border-indigo-200 rounded-md outline-none focus:ring-2 focus:ring-indigo-400">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-600">ç´¯ç©æœŸå¹´åŒ–å ±é…¬ç‡ (%)</label>
                    <input type="number" id="calcRate" value="6" step="0.1" class="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                    <p class="text-xs text-indigo-600 font-semibold uppercase tracking-wider">é ä¼°é€€ä¼‘ç¸½é‡‘é¡</p>
                    <p id="calcResult" class="text-2xl font-black text-indigo-800 mt-1">-- è¬</p>
                </div>
            </div>

            <!-- 2. é€€ä¼‘åƒæ•¸ (ä¸­é–“) -->
            <div class="card p-5 space-y-4 border-t-4 border-blue-500">
                <h2 class="text-xl font-bold text-blue-700 flex items-center">
                    <span class="mr-2">ğŸ </span> é€€ä¼‘åƒæ•¸è¨­å®š
                </h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-500">é€€ä¼‘å¹´é½¡ (è‡ªå‹•)</label>
                        <input type="number" id="retirementAge" value="61" disabled class="w-full p-2 border rounded-md outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-600">é ä¼°é¤˜å‘½</label>
                        <input type="number" id="lifeExpectancy" value="90" class="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-blue-600 font-bold">é€€ä¼‘ç¸½ç¾é‡‘ (è¬)</label>
                    <input type="number" id="totalCash" value="1000" class="w-full p-2 border border-blue-300 rounded-md outline-none focus:ring-2 focus:ring-blue-400 bg-blue-50">
                </div>

                <!-- è³‡ç”¢é…ç½®è¡¨æ ¼ -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700 font-bold">é€€ä¼‘è³‡ç”¢é…ç½®èˆ‡æŠ•å ±</label>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50">
                                    <th class="p-1 border text-slate-500">è³‡ç”¢é¡åˆ¥</th>
                                    <th class="p-1 border text-slate-500 w-16">æ¯”ä¾‹%</th>
                                    <th class="p-1 border text-slate-500">é‡‘é¡(è¬)</th>
                                    <th class="p-1 border text-slate-500 w-16">å¹´åŒ–%</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-1 border font-medium">è‚¡ç¥¨æŠ•è³‡</td>
                                    <td class="p-1 border"><input type="number" id="ratioStock" value="40" class="table-input"></td>
                                    <td class="p-1 border text-right" id="amtStock">0</td>
                                    <td class="p-1 border"><input type="number" id="rateStock" value="6" step="0.1" class="table-input"></td>
                                </tr>
                                <tr>
                                    <td class="p-1 border font-medium">å‚µåˆ¸æŠ•è³‡</td>
                                    <td class="p-1 border"><input type="number" id="ratioBond" value="40" class="table-input"></td>
                                    <td class="p-1 border text-right" id="amtBond">0</td>
                                    <td class="p-1 border"><input type="number" id="rateBond" value="3" step="0.1" class="table-input"></td>
                                </tr>
                                <tr>
                                    <td class="p-1 border font-medium">å®šå­˜/ç¾é‡‘</td>
                                    <td class="p-1 border"><input type="number" id="ratioCash" value="20" class="table-input"></td>
                                    <td class="p-1 border text-right" id="amtCash">0</td>
                                    <td class="p-1 border"><input type="number" id="rateCash" value="1" step="0.1" class="table-input"></td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-slate-50 font-bold">
                                <tr>
                                    <td class="p-1 border">åŠ æ¬Šç¸½è¨ˆ</td>
                                    <td class="p-1 border text-right" id="totalRatioText">100%</td>
                                    <td class="p-1 border text-right" id="totalAmtText">0</td>
                                    <td class="p-1 border text-right text-blue-600" id="avgRateText">0%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-red-600">æ¯æœˆæ”¯å‡º (å…ƒ)</label>
                        <input type="number" id="monthlyExpense" value="200000" step="1000" class="w-full p-2 border border-red-200 rounded-md outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-green-600">æ¯æœˆå¹´é‡‘ (å…ƒ)</label>
                        <input type="number" id="monthlyPension" value="18000" step="1000" class="w-full p-2 border border-green-200 rounded-md outline-none">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-600">é ä¼°é€šè†¨ (%)</label>
                    <input type="number" id="inflationRate" value="2" step="0.1" class="w-full p-2 border rounded-md outline-none">
                </div>

                <button onclick="calculateRetirement()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition mt-2">
                    é‡æ–°æ•´ç†åˆ†æ
                </button>
            </div>

            <!-- 3. çµæœèˆ‡åœ–è¡¨ (å³æ–¹) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-3 gap-4">
                    <div class="card p-4 text-center">
                        <p class="text-xs text-slate-500">å£½çµ‚å‰©é¤˜è³‡é‡‘</p>
                        <p id="finalBalance" class="text-xl font-bold text-slate-800">--</p>
                    </div>
                    <div class="card p-4 text-center">
                        <p class="text-xs text-slate-500">è³‡é‡‘ç¶­æŒå¹´é™</p>
                        <p id="duration" class="text-xl font-bold text-blue-600">--</p>
                    </div>
                    <div class="card p-4 text-center">
                        <p class="text-xs text-slate-500">è²¡å‹™ç‹€æ…‹</p>
                        <p id="statusMessage" class="text-xl font-bold">--</p>
                    </div>
                </div>

                <div class="card p-5 h-[350px]">
                    <canvas id="balanceChart"></canvas>
                </div>

                <div class="card overflow-hidden">
                    <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">é€€ä¼‘å¾Œè³‡ç”¢è®ŠåŒ–æ˜ç´° (è¬)</h3>
                        <span class="text-xs text-slate-400">â€» å–®ä½ï¼šè¬å…ƒ</span>
                    </div>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="w-full text-left border-collapse text-sm">
                            <thead class="bg-slate-50 sticky top-0 shadow-sm">
                                <tr>
                                    <th class="p-2 border-b">å¹´é½¡</th>
                                    <th class="p-2 border-b">æ”¯å‡º</th>
                                    <th class="p-2 border-b">æŠ•å ±é¡</th>
                                    <th class="p-2 border-b">å¹´é‡‘</th>
                                    <th class="p-2 border-b">å‰©é¤˜è³‡ç”¢</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;

        // --- æŠ•è³‡å ±é…¬ç‡è¨ˆç®—æ©Ÿé‚è¼¯ ---
        function calculateInvestment() {
            const currentAge = parseInt(document.getElementById('currentAge').value) || 0;
            const p = parseFloat(document.getElementById('calcInitial').value) || 0;
            const years = parseInt(document.getElementById('calcYears').value) || 0;
            const freq = parseInt(document.getElementById('calcFreq').value);
            const addAmount = parseFloat(document.getElementById('calcAddAmount').value) || 0;
            const annualRate = (parseFloat(document.getElementById('calcRate').value) || 0) / 100;

            const retAge = currentAge + years - (years > 0 ? 1 : 0);
            document.getElementById('retirementAge').value = retAge;

            const periodRate = annualRate / freq;
            const totalPeriods = years * freq;
            
            let futureValue = p * Math.pow(1 + periodRate, totalPeriods);
            if (periodRate > 0) {
                futureValue += addAmount * ((Math.pow(1 + periodRate, totalPeriods) - 1) / periodRate);
            } else {
                futureValue += addAmount * totalPeriods;
            }

            const roundedResult = Math.round(futureValue);
            document.getElementById('calcResult').innerText = roundedResult.toLocaleString() + ' è¬';
            document.getElementById('totalCash').value = roundedResult;
            
            calculateRetirement();
            return roundedResult;
        }

        // --- é€€ä¼‘åˆ†æé‚è¼¯ ---
        function calculateRetirement() {
            // 1. ç²å–åŸºæœ¬åƒæ•¸
            const startAge = parseInt(document.getElementById('retirementAge').value);
            const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);
            const totalCash = (parseFloat(document.getElementById('totalCash').value) || 0);
            const monthlyExpense = parseFloat(document.getElementById('monthlyExpense').value) || 0;
            const monthlyPension = parseFloat(document.getElementById('monthlyPension').value) || 0;
            const inflationRate = (parseFloat(document.getElementById('inflationRate').value) || 0) / 100;

            // 2. è™•ç†è³‡ç”¢é…ç½®èˆ‡å¹³å‡æŠ•å ±ç‡
            const rS = parseFloat(document.getElementById('ratioStock').value) || 0;
            const rB = parseFloat(document.getElementById('ratioBond').value) || 0;
            const rC = parseFloat(document.getElementById('ratioCash').value) || 0;
            
            const rateS = (parseFloat(document.getElementById('rateStock').value) || 0) / 100;
            const rateB = (parseFloat(document.getElementById('rateBond').value) || 0) / 100;
            const rateC = (parseFloat(document.getElementById('rateCash').value) || 0) / 100;

            const sumRatio = rS + rB + rC;
            document.getElementById('totalRatioText').innerText = sumRatio + '%';
            document.getElementById('totalRatioText').className = sumRatio > 100 ? 'p-1 border text-right text-red-600' : 'p-1 border text-right';
            
            // è¨ˆç®—å„é …é ä¼°é‡‘é¡
            const amtS = totalCash * (rS / 100);
            const amtB = totalCash * (rB / 100);
            const amtC = totalCash * (rC / 100);
            
            document.getElementById('amtStock').innerText = Math.round(amtS).toLocaleString();
            document.getElementById('amtBond').innerText = Math.round(amtB).toLocaleString();
            document.getElementById('amtCash').innerText = Math.round(amtC).toLocaleString();
            document.getElementById('totalAmtText').innerText = totalCash.toLocaleString();

            // åŠ æ¬Šå¹³å‡æŠ•å ±ç‡
            let avgReturnRate = 0;
            if (sumRatio > 0) {
                avgReturnRate = (rS * rateS + rB * rateB + rC * rateC) / sumRatio;
            }
            document.getElementById('avgRateText').innerText = (avgReturnRate * 100).toFixed(2) + '%';

            // 3. åŸ·è¡Œé€€ä¼‘é‡‘æµæ¨¡æ“¬
            let yearsOfRetirement = lifeExpectancy - startAge;
            let currentBalance = totalCash * 10000; // è½‰ç‚ºå…ƒ
            let labels = [startAge];
            let balances = [currentBalance / 10000];
            let tableHtml = '';
            let depletedAge = null;

            if (yearsOfRetirement <= 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">é€€ä¼‘å¹´é½¡å¤§æ–¼æˆ–ç­‰æ–¼é ä¼°é¤˜å‘½</td></tr>';
                return;
            }

            for (let i = 1; i <= yearsOfRetirement; i++) {
                let age = startAge + i;
                let investmentIncome = currentBalance * avgReturnRate;
                let yearlyExpense = monthlyExpense * 12 * Math.pow(1 + inflationRate, i - 1);
                let yearlyPension = monthlyPension * 12;

                currentBalance = currentBalance + investmentIncome + yearlyPension - yearlyExpense;

                if (currentBalance < 0 && depletedAge === null) {
                    depletedAge = age;
                }

                labels.push(age);
                balances.push(Math.max(0, currentBalance / 10000));

                tableHtml += `
                    <tr class="${currentBalance < 0 ? 'bg-red-50 text-red-500' : ''}">
                        <td class="p-2 border-b">${age} æ­²</td>
                        <td class="p-2 border-b text-red-500">-${(yearlyExpense / 10000).toFixed(1)}</td>
                        <td class="p-2 border-b text-green-600">+${(investmentIncome / 10000).toFixed(1)}</td>
                        <td class="p-2 border-b text-green-600">+${(yearlyPension / 10000).toFixed(1)}</td>
                        <td class="p-2 border-b font-bold">${(currentBalance / 10000).toFixed(0)}</td>
                    </tr>
                `;
            }

            document.getElementById('finalBalance').innerText = Math.round(currentBalance / 10000).toLocaleString() + ' è¬';
            document.getElementById('tableBody').innerHTML = tableHtml;
            
            const durEl = document.getElementById('duration');
            const msgEl = document.getElementById('statusMessage');
            
            if (depletedAge) {
                durEl.innerText = (depletedAge - startAge) + ' å¹´å¾Œè€—ç›¡';
                durEl.className = 'text-xl font-bold text-red-500';
                msgEl.innerText = 'è³‡ç”¢ä¸è¶³';
                msgEl.className = 'text-xl font-bold text-red-500';
            } else {
                durEl.innerText = yearsOfRetirement + ' å¹´+';
                durEl.className = 'text-xl font-bold text-green-600';
                msgEl.innerText = 'è²¡å‹™å¥åº·';
                msgEl.className = 'text-xl font-bold text-green-600';
            }

            updateChart(labels, balances);
        }

        function updateChart(labels, data) {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è³‡ç”¢(è¬)',
                        data: data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ç›£è½æ‰€æœ‰è¼¸å…¥
        window.onload = () => {
            const allInputs = document.querySelectorAll('input, select');
            allInputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (input.id.startsWith('calc') || input.id === 'currentAge') {
                        calculateInvestment();
                    } else {
                        calculateRetirement();
                    }
                });
            });
            calculateInvestment(); 
        };
    </script>
</body>
</html>